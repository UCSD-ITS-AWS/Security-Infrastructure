Parameters:
  LogMoveToGlacierDays:
    Type: Number
    MinValue: 1
    Default: 365
    MaxValue: 3653 # 10 yrs
  LogDeleteFromGlacierDays:
    Type: Number
    MinValue: 1
    Default: 2557 # 7 Yrs
    MaxValue: 7305 # 20 yrs
Outputs:
  LogBucketArn:
    Description: ARN for the S3 bucket created to house logs shipped from UCSD accounts.
    Value:
      Fn::GetAtt: ["LogTargetS3Bucket", "Arn"]
Resources:
  # create kinesis and lambda iam roles per https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CreateDestination.html
  LogIngestStream:
    Type: AWS::Kinesis::Stream
    Properties:
      ShardCount: 1
  LogIngestIAMPolicy:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument: {
          "Statement": {
            "Effect": "Allow",
            "Principal": { "Service": {"Fn::Join": [".", ["logs", {"Ref": "AWS::Region"}, "amazonaws.com"]]} },
            "Action": "sts:AssumeRole"
          }
        }
  LogTargetS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: LogDeliveryWrite
      LifecycleConfiguration:
        Rules:
        - Id: GlacierRule
          Prefix: glacier
          Status: Enabled
          ExpirationInDays:
            Ref: LogDeleteFromGlacierDays # Parameter
          Transitions:
            - TransitionInDays:
                Ref: LogMoveToGlacierDays # 1 yr default
              StorageClass: Glacier
# https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/S3ExportTasks.html - need to set security on bucket for this to hit cross-account
# Bucket policy for cross-account delivery of cloudtrail: https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-set-bucket-policy-for-multiple-accounts.html
# CloudWatch log delivery - https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CrossAccountSubscriptions.html
  SplunkLogForwarder:
    Type: AWS::Lambda::Function
    Properties: {}
